---
# Based on https://gist.github.com/belgattitude/838b2eba30c324f1f0033a797bab2e31
name: Setup CI
description: Setup pnpm, configure caches, and install dependencies

inputs:
  install-zig:
    description: 'Whether to install Zig (default: true)'
    required: false
    default: 'false'

runs:
  using: composite
  steps:
    - name: Setup pnpm
      uses: pnpm/action-setup@1e1c8eafbd745f64b1ef30a7d7ed7965034c486c
      with:
        run_install: false

    - name: Setup Node.js
      uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
      with:
        cache: pnpm
        node-version-file: .node-version

    - name: Setup Zig
      if: ${{ inputs.install-zig == 'true' }}
      uses: mlugg/setup-zig@e7d1537c378b83b8049f65dda471d87a2f7b2df2 # v2.2.0

    - name: Restore development related caches
      uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
      with:
        key: ${{ runner.os }}-development-cache-${{ hashFiles('**/pnpm-lock.yaml', '**/*.ts', 'turbo.json') }}
        path: |
          .cache
          **/.tsdown
          **/.turbo
          **/coverage
          **/tsconfig.tsbuildinfo
        restore-keys: ${{ runner.os }}-development-cache-

    - name: Bootstrap monorepo
      run: pnpm install
      shell: 'bash -Eeuo pipefail {0}'
