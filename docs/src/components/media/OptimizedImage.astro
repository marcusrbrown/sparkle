---
/**
 * Optimized Image Component for Astro Documentation
 *
 * Provides automatic image optimization with lazy loading, responsive sizing,
 * and proper accessibility attributes. Astro automatically converts images to
 * modern formats (WebP, AVIF) with appropriate fallbacks.
 *
 * For local images (imported via import statement), width and height are optional
 * as they are inferred from the source. For remote images, width and height must
 * be specified or use inferSize.
 *
 * @example
 * ```astro
 * ---
 * import OptimizedImage from '@/components/media/OptimizedImage.astro';
 * import myImage from '@/assets/example.jpg';
 * ---
 * <OptimizedImage src={myImage} alt="Example image" />
 * ```
 */

import {Image} from 'astro:assets'
import type {ImageMetadata} from 'astro'

export interface Props {
  /** Image source (imported ImageMetadata only) */
  src: ImageMetadata
  /** Alt text for accessibility (required) */
  alt: string
  /** Image width in pixels (optional for local images, inferred from source) */
  width?: number
  /** Image height in pixels (optional for local images, inferred from source) */
  height?: number
  /** Image loading strategy (defaults to lazy) */
  loading?: 'lazy' | 'eager'
  /** Image decoding strategy (defaults to async) */
  decoding?: 'async' | 'sync' | 'auto'
  /** Quality setting (0-100, defaults to 80) */
  quality?: number
  /** Densities for high-DPI displays */
  densities?: number[]
  /** Additional CSS classes */
  class?: string
  /** Fetch priority for above-the-fold images (defaults to auto) */
  fetchpriority?: 'high' | 'low' | 'auto'
}

const {
  src,
  alt,
  width,
  height,
  loading = 'lazy',
  decoding = 'async',
  quality = 80,
  densities,
  class: className,
  fetchpriority = 'auto',
} = Astro.props
---

<Image
  {src}
  {alt}
  {width}
  {height}
  {loading}
  {decoding}
  {quality}
  {densities}
  class={className}
  {fetchpriority}
/>

<style>
  :global(img) {
    /* Prevent Cumulative Layout Shift (CLS) */
    max-width: 100%;
    height: auto;

    /* Smooth image rendering */
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
  }

  /* Blur-up effect for lazy-loaded images */
  :global(img[loading='lazy']:not([src*='.svg'])) {
    background-color: var(--sl-color-gray-6, #f3f4f6);
    background-size: cover;
    background-position: center;
  }

  /* Dark mode optimization */
  :global([data-theme='dark'] img:not([src*='.svg'])) {
    opacity: 0.9;
  }

  @media (prefers-reduced-motion: reduce) {
    :global(img) {
      animation: none !important;
      transition: none !important;
    }
  }
</style>
